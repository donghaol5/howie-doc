---
layout: post
title: unix网络编程（tcp）
description: "tcp 协议流程介绍"
modified: 2014-05-11
tags: [varnish,web]
comments: true
share: true  
---


##UDP 用户数据报协议：

>UDP 是一个简单的传输协议，在RFC768 中详细介绍。UDP不保证数据报会到达目的地，不保证各个数据报到达的先后顺序，也不保证每个数据报只到达一次，如果丢失不会自动重传，所以UDP是一个不可靠的传输协议。 每个UDP数据报都有一个长度，如果一个数据报能正确到达目的地，那么长度也会被传递到接收应用端.


##TCP 传输控制协议：

>TCP提供与客户端之间的连接， 客户端先与服务端建立连接以后，再与服务端交换数据 ，最后关闭连接

>TCP提供了可靠性，当TCP向另一端发送数据时，要求对端一定要返回一个确认，如果没有确认 会等待更长时间或者重传，在数次重传失败后放弃。
注意 tcp 并不保证数据一定能背对方接受，不能被描述为 100%可靠的服务。提供数据的可靠性递送或故障的可靠性通知。
RTT（往返时间）算法 ： 动态估算客户端与服务端数据往返时间，目的是确认等待一个确认需要多少时间，

>TCP 通过给每个字节关联一个序号对所发送的数据进行排序，比如 一个应用发送2048个字节，导致tcp发送两个分节（分节是TCP传输数据的单元）
第一个分节序号1~1024，第二个分节序号1025~2048，如果这些分节不是按照顺序到达，接收端的TCP将先根据他们的序号从新排序。如果收到重复分节
可以根据序号来去重复

>TCP 提供流量控制，TCP总是告知对方在任何时候 它一次能从对端接收多少字节的数据 这称为通告窗口。在任何时刻 该窗口指出接收缓冲区当前的可用量
从而保证发送端发送的数据不会导致缓冲区溢出。该窗口动态变化：当接收来自发送端的数据时，窗口大小就减小。当接收端从缓冲区中读取数据时，窗口就变大
通告窗口大小减小到0 是有可能的：当tcp对应某个套接字的接收缓冲区已满时，导致他必须等待应用从该缓冲区读取数据后，才能从对端再接收数据。

>tcp连接是全双工的 ，意味着在一个给定的连接上应用可以在任何时刻在进出两个方向上既发送数据又接收数据。因此，tcp必须为每个数据流方向跟踪诸如序列号
和通知窗口大小等信息状态。


###1. TCP 连接建立（三次握手）：

1. 服务器准备好接收外来连接，通过调用socket，bind，listen这三个函数

2. 客户端通过connect发起主动打开，这时客户端会发送一个SYN（同步分节），告诉服务器客户端将要发送数据的初始序列号

3. 服务器确认（ACK）收到客户端的SYN， 同时也会发送一个SYN告诉客户端服务器将要发送数据的初始序列号

4. 客户端确认（ACK）服务端的SYN

<figure>
	<img src="{{site.url}}/images/three_way_handshake.png" alt="">
</figure>

>这种交换最少需要三个分组，所以成为三次握手。




###2. TCP 连接终止

1. 客户端或服务端调用close 进行主动关闭，此时该端会发送一个 FIN分节 表示数据发送完成

2. 接收到这个FIN的一端（被动关闭端），这个FIN由TCP确认。它的接收也作为一个文件结束符传给接收端的应用（放在已排队等候该应用接收的任何其他数据以后）

3. 过一段时间以后接收到这个文件结束符的应用将调用close关闭它的套接字，这是会发送一个FIN给主动关闭一端

4. 主动关闭端接收到最终FIN后，发送确认（ACK）这个FIN

<figure>
	<img src="{{site.url}}/images/four_way_handshake.jpg" alt="">
</figure>

>每一方都要发送一个FIN 和 ACK 所以需要4个分节完成这一过程，所以叫四次挥手 














